options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # ==================================================================
  # == Frontend Service (Vue.js)
  # ==================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'frontend-build'
    args:
      - 'build'
      - '-t'
      - 'europe-west3-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:${COMMIT_SHA}'
      - '.' # Use the Dockerfile in the root directory

  - name: 'gcr.io/cloud-builders/docker'
    id: 'frontend-push'
    args:
      - 'push'
      - 'europe-west3-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:${COMMIT_SHA}'
    waitFor: ['frontend-build']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'frontend-deploy'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_FRONTEND_SERVICE_NAME}'
      - '--image=europe-west3-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:${COMMIT_SHA}'
      - '--region=europe-west3'
      - '--platform=managed'
      - '--ingress=internal-and-cloud-load-balancing'
      - '--project=${PROJECT_ID}'
    waitFor: ['frontend-push']

  # ==================================================================
  # == Backend Service (Go)
  # ==================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'backend-build'
    args:
      - 'build'
      - '-t'
      - 'europe-west3-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:${COMMIT_SHA}'
      - './backend' # Specify the backend directory

  - name: 'gcr.io/cloud-builders/docker'
    id: 'backend-push'
    args:
      - 'push'
      - 'europe-west3-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:${COMMIT_SHA}'
    waitFor: ['backend-build']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'backend-deploy'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_BACKEND_SERVICE_NAME}'
      - '--image=europe-west3-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:${COMMIT_SHA}'
      - '--region=europe-west3'
      - '--platform=managed'
      - '--ingress=internal-and-cloud-load-balancing'
      - '--project=${PROJECT_ID}'
      # Set the SMTP_PASS secret from Secret Manager
      - '--update-secrets=SMTP_PASS=${_SMTP_SECRET_NAME}:latest'
    waitFor: ['backend-push']

# Substitution variables to be configured in the Cloud Build trigger.
substitutions:
  _FRONTEND_SERVICE_NAME: 'ivmanto-com'
  _BACKEND_SERVICE_NAME: 'ivmanto-backend-service'
  _REPO_NAME: 'ivmanto-com-repo'
  _SMTP_SECRET_NAME: 'smtp-password'

# The image created by this build.
images:
  - 'europe-west3-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:${COMMIT_SHA}'
  - 'europe-west3-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:${COMMIT_SHA}'
